<!DOCTYPE html>
<html lang="en" translate="no">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>O:/></title>
	<link href="index.css" rel="stylesheet" type="text/css" media="all">
    <meta name="google" content="notranslate">
        <style>
            #chat-container {
                width: 100%;
                max-width: 50ch;
                height: 70vh;
                display: flex;
                flex-direction: column;
                margin: 2vh auto;
                padding: 0 4vh;
            }

            #chat-messages {
                flex: 1;
                overflow-y: auto;
                padding: 1.5vh;
                background: var(--lcd-color);
                outline: 0.5vh solid var(--lcd-color);
                outline-offset: 1vh;
                margin-bottom: 1.5vh;
                scrollbar-color: var(--shadow-color) var(--lcd-color);
            }

            .message {
                margin-bottom: 1vh;
                opacity: 0;
                animation: lcd-flicker-on 0.2s step-start forwards;
            }

            .message.user {
                text-align: right;
            }

            .message.leo {
                text-align: left;
            }

            .message-content {
                display: inline-block;
                padding: 0.8vh 1.2vh;
                background: white;
                color: var(--lcd-color);
                border: 0.5vh solid var(--lcd-color);
                text-shadow: var(--invert-text-shadow);
                font-weight: bold;
                max-width: 80%;
                word-wrap: break-word;
                font-size: 0.85em;
            }

            .message.leo .message-content {
                background: var(--lcd-color);
                color: white;
                text-shadow: var(--bivert-text-shadow);
            }

            .message-content a {
                color: inherit;
                text-decoration: underline;
            }

            .message-content a:hover {
                opacity: 0.8;
            }

            #chat-input-container {
                display: flex;
                gap: 1vh;
            }

            #chat-input {
                flex: 1;
                padding: 0.8vh;
                background: white;
                color: var(--lcd-color);
                border: 0.5vh solid var(--lcd-color);
                font-family: 'meow';
                font-size: 2.5vh;
                letter-spacing: 0.2vh;
                outline: none;
                text-shadow: var(--invert-text-shadow);
            }

            #chat-input:focus {
                background: var(--lcd-color);
                color: white;
                text-shadow: var(--bivert-text-shadow);
                outline: 0.5vh solid var(--shadow-color);
                outline-offset: 1vh;
                border-color: var(--shadow-color);
            }

            #send-button {
                padding: 0.8vh 1.8vh;
                background: white;
                color: var(--lcd-color);
                border: 0.5vh solid var(--lcd-color);
                font-family: 'meow';
                font-size: 2.5vh;
                letter-spacing: 0.2vh;
                cursor: pointer;
                text-shadow: var(--invert-text-shadow);
                font-weight: bold;
                transition: all 0.2s;
            }

            #send-button:hover {
                background: var(--lcd-color);
                color: white;
                text-shadow: var(--bivert-text-shadow);
            }

            #send-button:focus {
                background: var(--lcd-color);
                color: white;
                text-shadow: var(--bivert-text-shadow);
                outline: 0.5vh solid var(--shadow-color);
                outline-offset: 1vh;
                border-color: var(--shadow-color);
            }

            #send-button:active {
                background: var(--shadow-color);
                outline: 0.5vh solid var(--shadow-color);
                outline-offset: 1vh;
            }

            #send-button:active {
                background: var(--shadow-color);
            }

            .typing-indicator {
                display: none;
                padding: 1vh 1.5vh;
                background: var(--lcd-color);
                color: white;
                border: 0.5vh solid var(--lcd-color);
                text-shadow: var(--bivert-text-shadow);
                display: inline-block;
            }

            .typing-indicator.active {
                display: inline-block;
            }
        </style>
</head>
<body class="flex">
    <button id="copy-address" class="copy-button" data-full-text="..."></button>
    <div id="motd" class="flex bivert">
        <div id="chat-container">
            <div id="chat-messages"></div>
            <div id="chat-input-container">
                <input type="text" id="chat-input" placeholder="ask leo anything..." autocomplete="off">
                <button id="send-button">send</button>
            </div>
            <div style="text-align: center; margin-top: 2vh;">
                <a href="second.html" style="font-size: 0.8em; opacity: 0.7;">← back</a>
            </div>
        </div>
    </div>
</body>
<svg width="0" height="0">
	<filter id="pixelate" x="0" y="0">
		<feFlood x="4" y="4" height="0.5" width="0.5" />
		<feComposite width="2" height="2" />
		<feTile result="a" />
		<feComposite in="SourceGraphic" in2="a" operator="in" />
		<feMorphology operator="dilate" radius="1" />
	</filter>
</svg>
<script>
    // Copy address button functionality
    document.addEventListener('DOMContentLoaded', function() {
        const copyButton = document.getElementById('copy-address');
        if (copyButton) {
            const fullText = copyButton.getAttribute('data-full-text');
            const firstSix = fullText.substring(0, 6);
            const displayText = 'ca: ' + firstSix + '...pump';
            copyButton.textContent = displayText;
            
            copyButton.addEventListener('click', function() {
                navigator.clipboard.writeText(fullText).then(function() {
                    copyButton.textContent = 'copied!';
                    setTimeout(function() {
                        copyButton.textContent = displayText;
                    }, 1000);
                }).catch(function(err) {
                    console.error('Failed to copy:', err);
                });
            });
        }

        // Chat functionality
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');

        // Generate a NEW session ID every time the page loads
        // This ensures each page visit creates a new conversation
        const sessionId = 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);

        // API endpoint - automatically detect if running on Render or locally
        const API_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:3000/api/leo-chat'
            : `${window.location.protocol}//${window.location.host}/api/leo-chat`;

        // Add welcome message (always show for new conversation)
        addMessage('leo', 'hello! ₍^•⩊•^₎ i\'m leo, ask me anything!');

        function addMessage(sender, text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            // Convert URLs to clickable links
            const textWithLinks = text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" style="color: inherit; text-decoration: underline;">$1</a>');
            contentDiv.innerHTML = textWithLinks;
            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function getLeoResponse(userMessage) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: userMessage,
                        sessionId: sessionId
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to get response');
                }

                const data = await response.json();
                return data.response;
            } catch (error) { // Further fallback error handling
                console.error('Error:', error);
                // Fallback response if API fails
                return 'oops, something went wrong... ₍^•⩊•^₎ try again?';
            }
        }

        async function sendMessage() {
            const message = chatInput.value.trim();
            if (message === '') return;

            // Add user message
            addMessage('user', message);
            chatInput.value = '';
            chatInput.disabled = true;
            sendButton.disabled = true;

            // Show typing indicator
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message leo';
            const typingContent = document.createElement('div');
            typingContent.className = 'message-content typing-indicator active';
            typingContent.textContent = 'leo is thinking...';
            typingDiv.appendChild(typingContent);
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            try {
                // Get response from API
                const response = await getLeoResponse(message);
                
                // Remove typing indicator
                chatMessages.removeChild(typingDiv);
                
                // Add Leo's response
                addMessage('leo', response);
            } catch (error) {
                // Remove typing indicator
                if (chatMessages.contains(typingDiv)) {
                    chatMessages.removeChild(typingDiv);
                }
                addMessage('leo', 'oops, something went wrong... ₍^•⩊•^₎ try again?');
            } finally {
                chatInput.disabled = false;
                sendButton.disabled = false;
                chatInput.focus();
            }
        }

        sendButton.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Focus input on load
        chatInput.focus();
    });
</script>
</html>

